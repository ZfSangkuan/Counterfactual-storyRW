

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>aser.database.kg_connection &mdash; ASER 2.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> ASER
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/get-started.html">Get Started</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/database.html">Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/extractor.html">Extractor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/conceptualizer.html">Conceptualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/aser-cs.html">Server/Client</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ASER</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>aser.database.kg_connection</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aser.database.kg_connection</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">heapq</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">..concept</span> <span class="kn">import</span> <span class="n">ASERConcept</span><span class="p">,</span> <span class="n">ASERConceptInstancePair</span>
<span class="kn">from</span> <span class="nn">..eventuality</span> <span class="kn">import</span> <span class="n">Eventuality</span>
<span class="kn">from</span> <span class="nn">..relation</span> <span class="kn">import</span> <span class="n">Relation</span><span class="p">,</span> <span class="n">relation_senses</span>
<span class="kn">from</span> <span class="nn">..database.db_connection</span> <span class="kn">import</span> <span class="n">SqliteDBConnection</span><span class="p">,</span> <span class="n">MongoDBConnection</span>
<span class="kn">from</span> <span class="nn">..database.utils</span> <span class="kn">import</span> <span class="n">compute_overlap</span>

<span class="n">CHUNKSIZE</span> <span class="o">=</span> <span class="mi">32768</span>

<span class="n">EVENTUALITY_TABLE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Eventualities&quot;</span>
<span class="n">EVENTUALITY_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="s2">&quot;frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;pattern&quot;</span><span class="p">,</span> <span class="s2">&quot;verbs&quot;</span><span class="p">,</span> <span class="s2">&quot;skeleton_words&quot;</span><span class="p">,</span> <span class="s2">&quot;words&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">]</span>
<span class="n">EVENTUALITY_COLUMN_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PRIMARY KEY&quot;</span><span class="p">,</span> <span class="s2">&quot;REAL&quot;</span><span class="p">,</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span> <span class="s2">&quot;BLOB&quot;</span><span class="p">]</span>

<span class="n">CONCEPT_TABLE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Concepts&quot;</span>
<span class="n">CONCEPT_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="s2">&quot;pattern&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">]</span>
<span class="n">CONCEPT_COLUMN_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PRIMARY KEY&quot;</span><span class="p">,</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span> <span class="s2">&quot;BLOB&quot;</span><span class="p">]</span>

<span class="n">RELATION_TABLE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Relations&quot;</span>
<span class="n">RELATION_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="s2">&quot;hid&quot;</span><span class="p">,</span> <span class="s2">&quot;tid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">relation_senses</span>
<span class="n">RELATION_COLUMN_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PRIMARY KEY&quot;</span><span class="p">,</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;REAL&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">relation_senses</span><span class="p">)</span>

<span class="n">CONCEPTINSTANCEPAIR_TABLE_NAME</span> <span class="o">=</span> <span class="s2">&quot;ConceptInstancePairs&quot;</span>
<span class="n">CONCEPTINSTANCEPAIR_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="s2">&quot;cid&quot;</span><span class="p">,</span> <span class="s2">&quot;eid&quot;</span><span class="p">,</span> <span class="s2">&quot;pattern&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">]</span>
<span class="n">CONCEPTINSTANCEPAIR_COLUMN_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PRIMARY KEY&quot;</span><span class="p">,</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span> <span class="s2">&quot;REAL&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="ASERKGConnection"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERKGConnection">[docs]</a><span class="k">class</span> <span class="nc">ASERKGConnection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; KG connection for ASER (including eventualities and relations)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s2">&quot;sqlite&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;cache&quot;</span><span class="p">,</span> <span class="n">grain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">CHUNKSIZE</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param db_path: database path</span>
<span class="sd">        :type db_path: str</span>
<span class="sd">        :param db: the backend database, e.g., &quot;sqlite&quot; or &quot;mongodb&quot;</span>
<span class="sd">        :type db: str (default = &quot;sqlite&quot;)</span>
<span class="sd">        :param mode: the mode to use the connection.</span>
<span class="sd">            &quot;insert&quot;: this connection is only used to insert/update rows;</span>
<span class="sd">            &quot;cache&quot;: this connection caches some contents that have been retrieved;</span>
<span class="sd">            &quot;memory&quot;: this connection loads all contents in memory;</span>
<span class="sd">        :type mode: str (default = &quot;cache&quot;)</span>
<span class="sd">        :param grain: the grain to build cache</span>
<span class="sd">            &quot;words&quot;: cache is built on &quot;verbs&quot;, &quot;skeleton_words&quot;, and &quot;words&quot;</span>
<span class="sd">            &quot;skeleton_words&quot;: cache is built on &quot;verbs&quot;, and &quot;skeleton_words&quot;</span>
<span class="sd">            &quot;verbs&quot;: cache is built on &quot;verbs&quot;</span>
<span class="sd">            None: no cache</span>
<span class="sd">        :type grain: Union[str, None] (default = None)</span>
<span class="sd">        :param chunksize: the chunksize to load/write database</span>
<span class="sd">        :type chunksize: int (default = 32768)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">db</span> <span class="o">==</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span> <span class="o">=</span> <span class="n">SqliteDBConnection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">db</span> <span class="o">==</span> <span class="s2">&quot;mongodb&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span> <span class="o">=</span> <span class="n">MongoDBConnection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: </span><span class="si">%s</span><span class="s2"> database is not supported!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;insert&quot;</span><span class="p">,</span> <span class="s2">&quot;cache&quot;</span><span class="p">,</span> <span class="s2">&quot;memory&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;only support insert/cache/memory modes.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">grain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;verbs&quot;</span><span class="p">,</span> <span class="s2">&quot;skeleton_words&quot;</span><span class="p">,</span> <span class="s2">&quot;words&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: only support None/verbs/skeleton_words/words grain.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grain</span> <span class="o">=</span> <span class="n">grain</span>  <span class="c1"># None, verbs, skeleton_words, words</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eventuality_table_name</span> <span class="o">=</span> <span class="n">EVENTUALITY_TABLE_NAME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eventuality_columns</span> <span class="o">=</span> <span class="n">EVENTUALITY_COLUMNS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eventuality_column_types</span> <span class="o">=</span> <span class="n">EVENTUALITY_COLUMN_TYPES</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span> <span class="o">=</span> <span class="n">RELATION_TABLE_NAME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relation_columns</span> <span class="o">=</span> <span class="n">RELATION_COLUMNS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relation_column_types</span> <span class="o">=</span> <span class="n">RELATION_COLUMN_TYPES</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eid2eventuality_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grain</span> <span class="o">==</span> <span class="s2">&quot;words&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partial2eids_cache</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;verbs&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(),</span> <span class="s2">&quot;skeleton_words&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(),</span> <span class="s2">&quot;words&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()}</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">grain</span> <span class="o">==</span> <span class="s2">&quot;skeleton_words&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partial2eids_cache</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;verbs&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(),</span> <span class="s2">&quot;skeleton_words&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()}</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">grain</span> <span class="o">==</span> <span class="s2">&quot;verbs&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partial2eids_cache</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;verbs&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partial2eids_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hid&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

<div class="viewcode-block" id="ASERKGConnection.init"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERKGConnection.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initialize the ASERKGConnection, including creating tables, loading eids and rids, and building cache</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">column_types</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eventuality_table_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eventuality_columns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_columns</span><span class="p">],</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eventuality_column_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_column_types</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: </span><span class="si">%s</span><span class="s2">_columns and </span><span class="si">%s</span><span class="s2">_column_types must be defined&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">column_types</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_eventuality</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eventuality_table_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventuality_columns</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eid2eventuality_cache</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
                <span class="c1"># handle another cache</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2eids_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">k</span><span class="p">))]</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">k</span><span class="p">))]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_relation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_columns</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
                <span class="c1"># handle another cache</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eventuality_table_name</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="ASERKGConnection.close"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERKGConnection.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Close the ASERKGConnection safely</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eid2eventuality_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="c1"># close another cache</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2eids_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partial2eids_cache</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    KG (Eventualities)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_convert_eventuality_to_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventuality</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">})</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventuality_columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">eventuality</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">row</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">row</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eventuality</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="k">def</span> <span class="nf">_convert_row_to_eventuality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">eventuality</span> <span class="o">=</span> <span class="n">Eventuality</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">])</span>
        <span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span>
        <span class="n">eventuality</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">]</span>
        <span class="n">eventuality</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;pattern&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">eventuality</span>

<div class="viewcode-block" id="ASERKGConnection.get_eventuality_columns"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERKGConnection.get_eventuality_columns">[docs]</a>    <span class="k">def</span> <span class="nf">get_eventuality_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get column information from eventualities</span>

<span class="sd">        :param columns: the columns to retrieve</span>
<span class="sd">        :type columns: List[str]</span>
<span class="sd">        :return: a list of retrieved rows</span>
<span class="sd">        :rtype: List[Dict[str, object]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eventuality_table_name</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_insert_eventuality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventuality</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_eventuality_to_row</span><span class="p">(</span><span class="n">eventuality</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">insert_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eventuality_table_name</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;cache&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eid2eventuality_cache</span><span class="p">[</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="n">eventuality</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2eids_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">eventuality</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">v</span><span class="p">[</span><span class="n">eventuality</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eid2eventuality_cache</span><span class="p">[</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="n">eventuality</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2eids_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">eventuality</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">v</span><span class="p">[</span><span class="n">eventuality</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v</span><span class="p">[</span><span class="n">eventuality</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">eventuality</span>

    <span class="k">def</span> <span class="nf">_insert_eventualities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventualities</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_eventuality_to_row</span><span class="p">,</span> <span class="n">eventualities</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">insert_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eventuality_table_name</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">eventuality</span> <span class="ow">in</span> <span class="n">eventualities</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;cache&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">eventuality</span> <span class="ow">in</span> <span class="n">eventualities</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eid2eventuality_cache</span><span class="p">[</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="n">eventuality</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2eids_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">eventuality</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="n">eventuality</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">eventuality</span> <span class="ow">in</span> <span class="n">eventualities</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eid2eventuality_cache</span><span class="p">[</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="n">eventuality</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2eids_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">eventuality</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="n">eventuality</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="n">eventuality</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">eventualities</span>

    <span class="k">def</span> <span class="nf">_get_eventuality_and_store_in_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eid</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_eventualities_and_store_in_cache</span><span class="p">([</span><span class="n">eid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_eventualities_and_store_in_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eids</span><span class="p">):</span>
        <span class="n">eventualities</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_eventuality</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">select_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eventuality_table_name</span><span class="p">,</span> <span class="n">eids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventuality_columns</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">eventuality</span> <span class="ow">in</span> <span class="n">eventualities</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">eventuality</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eid2eventuality_cache</span><span class="p">[</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="n">eventuality</span>
                <span class="c1"># It seems not to need to append</span>
                <span class="c1"># if self.mode == &quot;cache&quot;:</span>
                <span class="c1">#     for k, v in self.partial2eids_cache.items():</span>
                <span class="c1">#         if eventuality.get(k) in v:</span>
                <span class="c1">#             v[eventuality.get(k)].append(eventuality.eid)</span>
                <span class="c1"># elif self.mode == &quot;memory&quot;:</span>
                <span class="c1">#     for k, v in self.partial2eids_cache.items():</span>
                <span class="c1">#         if eventuality.get(k) not in v:</span>
                <span class="c1">#             v[eventuality.get(k)] = [eventuality.eid]</span>
                <span class="c1">#         else:</span>
                <span class="c1">#             v[eventuality.get(k)].append(eventuality.eid)</span>
        <span class="k">return</span> <span class="n">eventualities</span>

    <span class="k">def</span> <span class="nf">_update_eventuality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventuality</span><span class="p">):</span>
        <span class="c1"># update db</span>
        <span class="n">update_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_update_op</span><span class="p">([</span><span class="s2">&quot;frequency&quot;</span><span class="p">],</span> <span class="s2">&quot;+&quot;</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_eventuality_to_row</span><span class="p">(</span><span class="n">eventuality</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">update_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eventuality_table_name</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">update_op</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">])</span>

        <span class="c1"># updata cache</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># don&quot;t care</span>
        <span class="n">updated_eventuality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eid2eventuality_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">updated_eventuality</span><span class="p">:</span>  <span class="c1"># self.mode == &quot;memory&quot; or hit in cache</span>
            <span class="n">updated_eventuality</span><span class="o">.</span><span class="n">frequency</span> <span class="o">+=</span> <span class="n">eventuality</span><span class="o">.</span><span class="n">frequency</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># self.mode == &quot;cache&quot; and miss in cache</span>
            <span class="n">updated_eventuality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_eventuality_and_store_in_cache</span><span class="p">(</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">updated_eventuality</span>

    <span class="k">def</span> <span class="nf">_update_eventualities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventualities</span><span class="p">):</span>
        <span class="c1"># update db</span>
        <span class="n">update_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_update_op</span><span class="p">([</span><span class="s2">&quot;frequency&quot;</span><span class="p">],</span> <span class="s2">&quot;+&quot;</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_eventuality_to_row</span><span class="p">,</span> <span class="n">eventualities</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">update_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eventuality_table_name</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">update_op</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">])</span>

        <span class="c1"># update cache</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">eventualities</span><span class="p">)</span>  <span class="c1"># don&quot;t care</span>
        <span class="n">updated_eventualities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">missed_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">missed_eids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">eventuality</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eventualities</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="p">:</span>
                <span class="n">updated_eventualities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">updated_eventuality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eid2eventuality_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">updated_eventualities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">updated_eventuality</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">updated_eventuality</span><span class="p">:</span>
                    <span class="n">updated_eventuality</span><span class="o">.</span><span class="n">frequency</span> <span class="o">+=</span> <span class="n">eventuality</span><span class="o">.</span><span class="n">frequency</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">missed_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">missed_eids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">updated_eventuality</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_eventualities_and_store_in_cache</span><span class="p">(</span><span class="n">missed_eids</span><span class="p">)):</span>
            <span class="n">updated_eventualities</span><span class="p">[</span><span class="n">missed_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">updated_eventuality</span>
        <span class="k">return</span> <span class="n">updated_eventualities</span>

<div class="viewcode-block" id="ASERKGConnection.insert_eventuality"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERKGConnection.insert_eventuality">[docs]</a>    <span class="k">def</span> <span class="nf">insert_eventuality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventuality</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Insert/Update an eventuality into ASER</span>
<span class="sd">        (suggestion: consider to use `insert_eventualities` if you want to insert multiple eventualities)</span>

<span class="sd">        :param eventuality: an eventuality to insert/update</span>
<span class="sd">        :type eventuality: aser.eventuality.Eventuality</span>
<span class="sd">        :return: the inserted/updated eventuality</span>
<span class="sd">        :rtype: aser.eventuality.Eventuality</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_eventuality</span><span class="p">(</span><span class="n">eventuality</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_eventuality</span><span class="p">(</span><span class="n">eventuality</span><span class="p">)</span></div>

<div class="viewcode-block" id="ASERKGConnection.insert_eventualities"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERKGConnection.insert_eventualities">[docs]</a>    <span class="k">def</span> <span class="nf">insert_eventualities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventualities</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Insert/Update eventualities into ASER</span>

<span class="sd">        :param eventualities: eventualities to insert/update</span>
<span class="sd">        :type eventualities: List[aser.eventuality.Eventuality]</span>
<span class="sd">        :return: the inserted/updated eventualities</span>
<span class="sd">        :rtype: List[aser.eventuality.Eventuality]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_eventualities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">existing_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">existing_eventualities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">eventuality</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eventualities</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="p">:</span>
                <span class="n">new_eventualities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eventuality</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eventuality</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">existing_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">existing_eventualities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eventuality</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_eventualities</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insert_eventualities</span><span class="p">(</span><span class="n">new_eventualities</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing_eventualities</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">updated_eventuality</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_eventualities</span><span class="p">(</span><span class="n">existing_eventualities</span><span class="p">)):</span>
                <span class="n">results</span><span class="p">[</span><span class="n">existing_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">updated_eventuality</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="ASERKGConnection.get_exact_match_eventuality"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERKGConnection.get_exact_match_eventuality">[docs]</a>    <span class="k">def</span> <span class="nf">get_exact_match_eventuality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventuality</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve an exact matched eventuality from ASER</span>
<span class="sd">        (suggestion: consider to use `get_exact_match_eventualities` if you want to retrieve multiple eventualities)</span>

<span class="sd">        :param eventuality: an eventuality that contains the eid</span>
<span class="sd">        :type eventuality: Union[aser.eventuality.Eventuality, Dict[str, object], str]</span>
<span class="sd">        :return: the exact matched eventuality</span>
<span class="sd">        :rtype: aser.eventuality.Eventuality</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eventuality</span><span class="p">,</span> <span class="n">Eventuality</span><span class="p">):</span>
            <span class="n">eid</span> <span class="o">=</span> <span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eventuality</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">eid</span> <span class="o">=</span> <span class="n">eventuality</span><span class="p">[</span><span class="s2">&quot;eid&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eventuality</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">eid</span> <span class="o">=</span> <span class="n">eventuality</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: eventuality should be an instance of Eventuality, a dictionary, or a eid.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">eid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">exact_match_eventuality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eid2eventuality_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exact_match_eventuality</span><span class="p">:</span>
            <span class="n">exact_match_eventuality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_eventuality_and_store_in_cache</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">exact_match_eventuality</span></div>

<div class="viewcode-block" id="ASERKGConnection.get_exact_match_eventualities"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERKGConnection.get_exact_match_eventualities">[docs]</a>    <span class="k">def</span> <span class="nf">get_exact_match_eventualities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventualities</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve multiple exact matched eventualities from ASER</span>

<span class="sd">        :param eventualities: eventualities</span>
<span class="sd">        :type eventualities: Union[List[aser.eventuality.Eventuality], List[Dict[str, object]], List[str]]</span>
<span class="sd">        :return: the exact matched eventualities</span>
<span class="sd">        :rtype: List[aser.eventuality.Eventuality]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">exact_match_eventualities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eventualities</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eventualities</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Eventuality</span><span class="p">):</span>
                <span class="n">eids</span> <span class="o">=</span> <span class="p">[</span><span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span> <span class="k">for</span> <span class="n">eventuality</span> <span class="ow">in</span> <span class="n">eventualities</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eventualities</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">eids</span> <span class="o">=</span> <span class="p">[</span><span class="n">eventuality</span><span class="p">[</span><span class="s2">&quot;eid&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">eventuality</span> <span class="ow">in</span> <span class="n">eventualities</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eventualities</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">eids</span> <span class="o">=</span> <span class="n">eventualities</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: eventualities should instances of Eventuality, dictionaries, or eids.&quot;</span><span class="p">)</span>

            <span class="n">missed_indices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">missed_eids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">eid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eids</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">eid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="p">:</span>
                    <span class="n">exact_match_eventualities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">exact_match_eventuality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eid2eventuality_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">exact_match_eventualities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exact_match_eventuality</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exact_match_eventuality</span><span class="p">:</span>
                    <span class="n">missed_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">missed_eids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">exact_match_eventuality</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_eventualities_and_store_in_cache</span><span class="p">(</span><span class="n">missed_eids</span><span class="p">)):</span>
                <span class="n">exact_match_eventualities</span><span class="p">[</span><span class="n">missed_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">exact_match_eventuality</span>
        <span class="k">return</span> <span class="n">exact_match_eventualities</span></div>

<div class="viewcode-block" id="ASERKGConnection.get_eventualities_by_keys"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERKGConnection.get_eventualities_by_keys">[docs]</a>    <span class="k">def</span> <span class="nf">get_eventualities_by_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bys</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">order_bys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve multiple partial matched eventualities by keys and values from ASER</span>

<span class="sd">        :param bys: the given columns to match</span>
<span class="sd">        :type bys: List[str]</span>
<span class="sd">        :param keys: the given values to match</span>
<span class="sd">        :type keys: List[str]</span>
<span class="sd">        :param order_bys: the columns whose value are used to sort rows</span>
<span class="sd">        :type order_bys: List[str]</span>
<span class="sd">        :param reverse: whether to sort in a reversed order</span>
<span class="sd">        :type reverse: bool</span>
<span class="sd">        :param top_n: how many eventualities to return, default `None` for all eventualities</span>
<span class="sd">        :type top_n: int</span>
<span class="sd">        :return: the partial matched eventualities</span>
<span class="sd">        :rtype: List[aser.eventuality.Eventuality]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bys</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bys</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">bys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventuality_columns</span><span class="p">:</span>
                <span class="n">bys</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">by_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;words&quot;</span><span class="p">,</span> <span class="s2">&quot;skeleton_words&quot;</span><span class="p">,</span> <span class="s2">&quot;verbs&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">bys</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2eids_cache</span><span class="p">:</span>
                <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2eids_cache</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">by_index</span> <span class="o">=</span> <span class="n">bys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">keys</span><span class="p">[</span><span class="n">by_index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
                <span class="n">key_match_eventualities</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eid2eventuality_cache</span><span class="p">[</span><span class="n">eid</span><span class="p">]</span> <span class="k">for</span> <span class="n">eid</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="n">by_index</span><span class="p">]]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[]</span>
                <span class="n">key_cache</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">key_match_eventualities</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_eventuality</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_rows_by_keys</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">eventuality_table_name</span><span class="p">,</span> <span class="p">[</span><span class="n">bys</span><span class="p">[</span><span class="n">by_index</span><span class="p">]],</span> <span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="n">by_index</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventuality_columns</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">key_match_eventuality</span> <span class="ow">in</span> <span class="n">key_match_eventualities</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key_match_eventuality</span><span class="o">.</span><span class="n">eid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eid2eventuality_cache</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">eid2eventuality_cache</span><span class="p">[</span><span class="n">key_match_eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_match_eventuality</span>
                    <span class="n">key_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key_match_eventuality</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
                <span class="n">cache</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="n">by_index</span><span class="p">]]</span> <span class="o">=</span> <span class="n">key_cache</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bys</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">by_index</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">key_match_eventualities</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">bys</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">key_match_eventualities</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">order_bys</span><span class="p">:</span>
                <span class="n">key_match_eventualities</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="n">order_bys</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">top_n</span><span class="p">:</span>
                <span class="n">key_match_eventualities</span> <span class="o">=</span> <span class="n">key_match_eventualities</span><span class="p">[:</span><span class="n">top_n</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">key_match_eventualities</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_eventuality</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_rows_by_keys</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">eventuality_table_name</span><span class="p">,</span>
                    <span class="n">bys</span><span class="p">,</span>
                    <span class="n">keys</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">eventuality_columns</span><span class="p">,</span>
                    <span class="n">order_bys</span><span class="o">=</span><span class="n">order_bys</span><span class="p">,</span>
                    <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">,</span>
                    <span class="n">top_n</span><span class="o">=</span><span class="n">top_n</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ASERKGConnection.get_partial_match_eventualities"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERKGConnection.get_partial_match_eventualities">[docs]</a>    <span class="k">def</span> <span class="nf">get_partial_match_eventualities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventuality</span><span class="p">,</span> <span class="n">bys</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve multiple partial matched eventualities by a given eventuality and properties from ASER</span>

<span class="sd">        :param eventuality: the given eventuality to match</span>
<span class="sd">        :type eventuality: aser.eventuality.Eventuality</span>
<span class="sd">        :param bys: the given properties to match</span>
<span class="sd">        :type bys: List[str]</span>
<span class="sd">        :param top_n: how many rows to return, default `None` for all rows</span>
<span class="sd">        :type top_n: int</span>
<span class="sd">        :param threshold: the minimum similarity</span>
<span class="sd">        :type threshold: float (default = 0.8)</span>
<span class="sd">        :param sort: whether to sort</span>
<span class="sd">        :type sort: bool (default = True)</span>
<span class="sd">        :return: the partial matched eventualities</span>
<span class="sd">        :rtype: List[aser.eventuality.Eventuality]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">grain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="c1"># exact match by skeleton_words, skeleton_words_clean or verbs, and compute similarity according type</span>
        <span class="k">for</span> <span class="n">by</span> <span class="ow">in</span> <span class="n">bys</span><span class="p">:</span>
            <span class="n">key_match_eventualities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eventualities_by_keys</span><span class="p">([</span><span class="n">by</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">eventuality</span><span class="p">,</span> <span class="n">by</span><span class="p">))])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_match_eventualities</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sort</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">top_n</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_match_eventualities</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">top_n</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">key_match_eventualities</span><span class="p">,</span> <span class="n">top_n</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">key_match_eventualities</span>
            <span class="c1"># sort by (similarity, frequency, idx)</span>
            <span class="n">queue</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">queue_len</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">key_match_eventuality</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">key_match_eventualities</span><span class="p">):</span>
                <span class="n">similarity</span> <span class="o">=</span> <span class="n">compute_overlap</span><span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">eventuality</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grain</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">key_match_eventuality</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grain</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">similarity</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">top_n</span> <span class="ow">or</span> <span class="n">queue_len</span> <span class="o">&lt;</span> <span class="n">top_n</span><span class="p">:</span>
                        <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="p">(</span><span class="n">similarity</span><span class="p">,</span> <span class="n">key_match_eventuality</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">key_match_eventuality</span><span class="p">))</span>
                        <span class="n">queue_len</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">heapq</span><span class="o">.</span><span class="n">heappushpop</span><span class="p">(</span>
                            <span class="n">queue</span><span class="p">,</span> <span class="p">(</span><span class="n">similarity</span><span class="p">,</span> <span class="n">key_match_eventuality</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">key_match_eventuality</span><span class="p">)</span>
                        <span class="p">)</span>
            <span class="n">key_match_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
                <span class="n">key_match_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">key_match_results</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">key_match_results</span>
        <span class="k">return</span> <span class="p">[]</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    KG (Relations)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_convert_relation_to_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">})</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">relation_senses</span><span class="p">)]:</span>
            <span class="n">row</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relation_senses</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">relation</span><span class="o">.</span><span class="n">relations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="k">def</span> <span class="nf">_convert_row_to_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Relation</span><span class="p">(</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;tid&quot;</span><span class="p">],</span> <span class="p">{</span><span class="n">r</span><span class="p">:</span> <span class="n">cnt</span>
                                     <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cnt</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">}</span>
        <span class="p">)</span>

<div class="viewcode-block" id="ASERKGConnection.get_relation_columns"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERKGConnection.get_relation_columns">[docs]</a>    <span class="k">def</span> <span class="nf">get_relation_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get column information from relations</span>

<span class="sd">        :param columns: the columns to retrieve</span>
<span class="sd">        :type columns: List[str]</span>
<span class="sd">        :return: a list of retrieved rows</span>
<span class="sd">        :rtype: List[Dict[str, object]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_insert_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_relation_to_row</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">insert_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;cache&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">relation</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">relation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">v</span><span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">relation</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">relation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">v</span><span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v</span><span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">relation</span>

    <span class="k">def</span> <span class="nf">_insert_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relations</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_relation_to_row</span><span class="p">,</span> <span class="n">relations</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">insert_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;cache&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">relation</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">relation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">relation</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">relation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">relations</span>

    <span class="k">def</span> <span class="nf">_get_relation_and_store_in_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rid</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relations_and_store_in_cache</span><span class="p">([</span><span class="n">rid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_relations_and_store_in_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rids</span><span class="p">):</span>
        <span class="n">relations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_relation</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">select_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span> <span class="n">rids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_columns</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">relation</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">relation</span>
        <span class="k">return</span> <span class="n">relations</span>

    <span class="k">def</span> <span class="nf">_update_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation</span><span class="p">):</span>
        <span class="c1"># find new relation frequencies</span>
        <span class="n">update_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relation_senses</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">relation</span><span class="o">.</span><span class="n">relations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">update_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># update db</span>
        <span class="n">update_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_update_op</span><span class="p">(</span><span class="n">update_columns</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_relation_to_row</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">update_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">update_op</span><span class="p">,</span> <span class="n">update_columns</span><span class="p">)</span>

        <span class="c1"># update cache</span>
        <span class="n">updated_relation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">updated_relation</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">update_columns</span><span class="p">:</span>
                <span class="n">updated_relation</span><span class="o">.</span><span class="n">relation</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">+=</span> <span class="n">relation</span><span class="o">.</span><span class="n">relation</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">updated_relation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relation_and_store_in_cache</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">updated_relation</span>

    <span class="k">def</span> <span class="nf">_update_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relations</span><span class="p">):</span>
        <span class="c1"># update db</span>
        <span class="n">update_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_update_op</span><span class="p">(</span><span class="n">relation_senses</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_relation_to_row</span><span class="p">,</span> <span class="n">relations</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">update_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">update_op</span><span class="p">,</span> <span class="n">relation_senses</span><span class="p">)</span>

        <span class="c1"># update cache</span>
        <span class="n">updated_relations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">missed_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">missed_rids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">relation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">relations</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">relation</span><span class="o">.</span><span class="n">rid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="p">:</span>
                <span class="n">updated_relations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">updated_relation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">updated_relations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">updated_relations</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">updated_relation</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relation_senses</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">updated_relation</span><span class="o">.</span><span class="n">relations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                            <span class="n">updated_relation</span><span class="o">.</span><span class="n">relations</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">+=</span> <span class="n">relation</span><span class="o">.</span><span class="n">relations</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">missed_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">missed_rids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">updated_relation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_relations_and_store_in_cache</span><span class="p">(</span><span class="n">missed_rids</span><span class="p">)):</span>
            <span class="n">updated_relations</span><span class="p">[</span><span class="n">missed_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">updated_relation</span>
        <span class="k">return</span> <span class="n">updated_relations</span>

<div class="viewcode-block" id="ASERKGConnection.insert_relation"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERKGConnection.insert_relation">[docs]</a>    <span class="k">def</span> <span class="nf">insert_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Insert/Update a relation into ASER</span>
<span class="sd">        (suggestion: consider to use `insert_relations` if you want to insert multiple relations)</span>

<span class="sd">        :param relation: a relation to insert/update</span>
<span class="sd">        :type relation: aser.relation.Relation</span>
<span class="sd">        :return: the inserted/updated relation</span>
<span class="sd">        :rtype: aser.relation.Relation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">relation</span><span class="o">.</span><span class="n">rid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_relation</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_relation</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span></div>

<div class="viewcode-block" id="ASERKGConnection.insert_relations"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERKGConnection.insert_relations">[docs]</a>    <span class="k">def</span> <span class="nf">insert_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Insert/Update relations into ASER</span>

<span class="sd">        :param relations: relations to insert/update</span>
<span class="sd">        :type relations: List[aser.relation.Relation]</span>
<span class="sd">        :return: the inserted/updated relations</span>
<span class="sd">        :rtype: List[aser.relation.Relation]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_relations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">existing_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">existing_relations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">relation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">relations</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">relation</span><span class="o">.</span><span class="n">rid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="p">:</span>
                <span class="n">new_relations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">existing_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">existing_relations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_relations</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insert_relations</span><span class="p">(</span><span class="n">new_relations</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing_relations</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">updated_relation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_relations</span><span class="p">(</span><span class="n">existing_relations</span><span class="p">)):</span>
                <span class="n">results</span><span class="p">[</span><span class="n">existing_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">updated_relation</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="ASERKGConnection.get_exact_match_relation"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERKGConnection.get_exact_match_relation">[docs]</a>    <span class="k">def</span> <span class="nf">get_exact_match_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve an exact matched relation from ASER</span>
<span class="sd">        (suggestion: consider to use `get_exact_match_relations` if you want to retrieve multiple relations)</span>

<span class="sd">        :param relation: a relation that contains the rid or an eventuality pair that contains two eids</span>
<span class="sd">        :type relation: Union[aser.relation.Relation, Dict[str, object], str, Tuple[aser.eventuality.Eventuality, aser.eventuality.Eventuality], Tuple[str, str]]</span>
<span class="sd">        :return: the exact matched relation</span>
<span class="sd">        :rtype: aser.relation.Relation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="n">Relation</span><span class="p">):</span>
            <span class="n">rid</span> <span class="o">=</span> <span class="n">relation</span><span class="o">.</span><span class="n">rid</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">rid</span> <span class="o">=</span> <span class="n">relation</span><span class="p">[</span><span class="s2">&quot;rid&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">rid</span> <span class="o">=</span> <span class="n">relation</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Eventuality</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Eventuality</span><span class="p">):</span>
                <span class="n">rid</span> <span class="o">=</span> <span class="n">Relation</span><span class="o">.</span><span class="n">generate_rid</span><span class="p">(</span><span class="n">relation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">relation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">rid</span> <span class="o">=</span> <span class="n">Relation</span><span class="o">.</span><span class="n">generate_rid</span><span class="p">(</span><span class="n">relation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">relation</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Error: relation should be (an instance of Eventuality, an instance of Eventuality) or (hid, tid).&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Error: relation should be an instance of Relation, a dictionary, rid,&quot;</span>
                <span class="s2">&quot;(an instance of Eventuality, an instance of Eventuality), or (hid, tid).&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">rid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">exact_match_relation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exact_match_relation</span><span class="p">:</span>
            <span class="n">exact_match_relation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relation_and_store_in_cache</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">exact_match_relation</span></div>

<div class="viewcode-block" id="ASERKGConnection.get_exact_match_relations"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERKGConnection.get_exact_match_relations">[docs]</a>    <span class="k">def</span> <span class="nf">get_exact_match_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve exact matched relations from ASER</span>

<span class="sd">        :param relations: a relations that contain the rids or eventuality pairs each of which contains two eids</span>
<span class="sd">        :type relations: Union[List[aser.relation.Relation], List[Dict[str, object]], List[str], List[Tuple[aser.eventuality.Eventuality, aser.eventuality.Eventuality]], List[Tuple[str, str]]]</span>
<span class="sd">        :return: the exact matched relations</span>
<span class="sd">        :rtype: List[aser.relation.Relation]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">exact_match_relations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">relations</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Relation</span><span class="p">):</span>
                <span class="n">rids</span> <span class="o">=</span> <span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span> <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">rids</span> <span class="o">=</span> <span class="p">[</span><span class="n">relation</span><span class="p">[</span><span class="s2">&quot;rid&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">rids</span> <span class="o">=</span> <span class="n">relations</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">relations</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">Eventuality</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">Eventuality</span><span class="p">):</span>
                    <span class="n">rids</span> <span class="o">=</span> <span class="p">[</span><span class="n">Relation</span><span class="o">.</span><span class="n">generate_rid</span><span class="p">(</span><span class="n">relation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">relation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span> <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">rids</span> <span class="o">=</span> <span class="p">[</span><span class="n">Relation</span><span class="o">.</span><span class="n">generate_rid</span><span class="p">(</span><span class="n">relation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">relation</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Error: relations should be [(an instance of Eventuality, an instance of Eventuality), ...] or [(hid, tid), ...].&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Error: relations should be instances of Relation, dictionaries, rids, [(an instance of Eventuality, an instance of Eventuality), ...], or [(hid, tid), ...].&quot;</span>
                <span class="p">)</span>

            <span class="n">missed_indices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">missed_rids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">rid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rids</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">rid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="p">:</span>
                    <span class="n">exact_match_relations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">exact_match_relation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">exact_match_relations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exact_match_relation</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exact_match_relation</span><span class="p">:</span>
                    <span class="n">missed_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">missed_rids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">exact_match_relation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_relations_and_store_in_cache</span><span class="p">(</span><span class="n">missed_rids</span><span class="p">)):</span>
                <span class="n">exact_match_relations</span><span class="p">[</span><span class="n">missed_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">exact_match_relation</span>
        <span class="k">return</span> <span class="n">exact_match_relations</span></div>

<div class="viewcode-block" id="ASERKGConnection.get_relations_by_keys"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERKGConnection.get_relations_by_keys">[docs]</a>    <span class="k">def</span> <span class="nf">get_relations_by_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bys</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">order_bys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve multiple partial matched relations by keys and values from ASER</span>

<span class="sd">        :param bys: the given columns to match</span>
<span class="sd">        :type bys: List[str]</span>
<span class="sd">        :param keys: the given values to match</span>
<span class="sd">        :type keys: List[str]</span>
<span class="sd">        :param order_bys: the columns whose value are used to sort rows</span>
<span class="sd">        :type order_bys: Union[List[str], None] (default = None)</span>
<span class="sd">        :param reverse: whether to sort in a reversed order</span>
<span class="sd">        :type reverse: bool (default = False)</span>
<span class="sd">        :param top_n: how many relations to return, default `None` for all relations</span>
<span class="sd">        :type top_n: Union[int, None]  (default = None)</span>
<span class="sd">        :return: the partial matched relations</span>
<span class="sd">        :rtype: List[aser.relation.Relation]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bys</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bys</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">bys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_columns</span><span class="p">:</span>
                <span class="n">bys</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">by_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">,</span> <span class="s2">&quot;tid&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">bys</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">:</span>
                <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">by_index</span> <span class="o">=</span> <span class="n">bys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">keys</span><span class="p">[</span><span class="n">by_index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
                <span class="n">key_match_relations</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="n">by_index</span><span class="p">]]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[]</span>
                <span class="n">key_cache</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">key_match_relations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_relation</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_rows_by_keys</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span> <span class="p">[</span><span class="n">bys</span><span class="p">[</span><span class="n">by_index</span><span class="p">]],</span> <span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="n">by_index</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_columns</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">key_match_relation</span> <span class="ow">in</span> <span class="n">key_match_relations</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key_match_relation</span><span class="o">.</span><span class="n">rid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">[</span><span class="n">key_match_relation</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_match_relation</span>
                    <span class="n">key_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key_match_relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
                <span class="n">cache</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="n">by_index</span><span class="p">]]</span> <span class="o">=</span> <span class="n">key_cache</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bys</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">by_index</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">key_match_relations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">bys</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">key_match_relations</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">order_bys</span><span class="p">:</span>
                <span class="n">key_match_relations</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="n">order_bys</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">top_n</span><span class="p">:</span>
                <span class="n">key_match_relations</span> <span class="o">=</span> <span class="n">key_match_relations</span><span class="p">[:</span><span class="n">top_n</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">key_match_relations</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_relation</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_rows_by_keys</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span>
                    <span class="n">bys</span><span class="p">,</span>
                    <span class="n">keys</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">relation_columns</span><span class="p">,</span>
                    <span class="n">order_bys</span><span class="o">=</span><span class="n">order_bys</span><span class="p">,</span>
                    <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">,</span>
                    <span class="n">top_n</span><span class="o">=</span><span class="n">top_n</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Addtional APIs</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ASERKGConnection.get_related_eventualities"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERKGConnection.get_related_eventualities">[docs]</a>    <span class="k">def</span> <span class="nf">get_related_eventualities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventuality</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve related (connected) eventualities from ASER</span>

<span class="sd">        :param eventuality: an eventuality that contains the eid</span>
<span class="sd">        :type eventuality: Union[aser.eventuality.Eventuality, Dict[str, object], str]</span>
<span class="sd">        :return: the related eventualities</span>
<span class="sd">        :rtype: List[Tuple[aser.eventuality.Eventuality, aser.relation.Relation]]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eventuality</span><span class="p">,</span> <span class="n">Eventuality</span><span class="p">):</span>
            <span class="n">eid</span> <span class="o">=</span> <span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eventuality</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">eid</span> <span class="o">=</span> <span class="n">eventuality</span><span class="p">[</span><span class="s2">&quot;eid&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eventuality</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">eid</span> <span class="o">=</span> <span class="n">eventuality</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: eventuality should a instance of Eventuality, or eid.&quot;</span><span class="p">)</span>

        <span class="c1"># eid == hid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;hid&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">:</span>
                <span class="n">related_rids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="nb">list</span><span class="p">())</span>
                <span class="n">related_relations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_match_relations</span><span class="p">(</span><span class="n">related_rids</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">related_relations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relations_by_keys</span><span class="p">(</span><span class="n">bys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">eid</span><span class="p">])</span>
            <span class="n">tids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">tid</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">related_relations</span><span class="p">]</span>
            <span class="n">t_eventualities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_match_eventualities</span><span class="p">(</span><span class="n">tids</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;cache&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;hid&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">eid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">]:</span>  <span class="c1"># hit</span>
                    <span class="n">related_rids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="nb">list</span><span class="p">())</span>
                    <span class="n">related_relations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_match_relations</span><span class="p">(</span><span class="n">related_rids</span><span class="p">)</span>
                    <span class="n">tids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">tid</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">related_relations</span><span class="p">]</span>
                    <span class="n">t_eventualities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_match_eventualities</span><span class="p">(</span><span class="n">tids</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># miss</span>
                    <span class="n">related_relations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relations_by_keys</span><span class="p">(</span><span class="n">bys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">eid</span><span class="p">])</span>
                    <span class="n">tids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">tid</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">related_relations</span><span class="p">]</span>
                    <span class="n">t_eventualities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_match_eventualities</span><span class="p">(</span><span class="n">tids</span><span class="p">)</span>
                    <span class="c1"># update cache</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">][</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span> <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">related_relations</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">related_relations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relations_by_keys</span><span class="p">(</span><span class="n">bys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">eid</span><span class="p">])</span>
                <span class="n">tids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">tid</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">related_relations</span><span class="p">]</span>
                <span class="n">t_eventualities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_match_eventualities</span><span class="p">(</span><span class="n">tids</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">t_eventualities</span><span class="p">,</span> <span class="n">related_relations</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">relations</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span></div></div>


<div class="viewcode-block" id="ASERConceptConnection"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection">[docs]</a><span class="k">class</span> <span class="nc">ASERConceptConnection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Concept connection for ASER (including concepts, concept_instance_pairs, and relations)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s2">&quot;sqlite&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;cache&#39;</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">CHUNKSIZE</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param db_path: database path</span>
<span class="sd">        :type db_path: str</span>
<span class="sd">        :param db: the backend database, e.g., &quot;sqlite&quot; or &quot;mongodb&quot;</span>
<span class="sd">        :type db: str (default = sqlite)</span>
<span class="sd">        :param mode: the mode to use the connection.</span>
<span class="sd">            &quot;insert&quot;: this connection is only used to insert/update rows;</span>
<span class="sd">            &quot;cache&quot;: this connection caches some contents that have been retrieved;</span>
<span class="sd">            &quot;memory&quot;: this connection loads all contents in memory;</span>
<span class="sd">        :type mode: str (default = &quot;cache&quot;)</span>
<span class="sd">        :param chunksize: the chunksize to load/write database</span>
<span class="sd">        :type chunksize: int (default = 32768)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">db</span> <span class="o">==</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span> <span class="o">=</span> <span class="n">SqliteDBConnection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">db</span> <span class="o">==</span> <span class="s2">&quot;mongodb&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span> <span class="o">=</span> <span class="n">MongoDBConnection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Error: </span><span class="si">%s</span><span class="s2"> database is not supported!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;insert&quot;</span><span class="p">,</span> <span class="s2">&quot;cache&quot;</span><span class="p">,</span> <span class="s2">&quot;memory&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Error: only support insert/cache/memory modes.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">concept_table_name</span> <span class="o">=</span> <span class="n">CONCEPT_TABLE_NAME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concept_columns</span> <span class="o">=</span> <span class="n">CONCEPT_COLUMNS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concept_column_types</span> <span class="o">=</span> <span class="n">CONCEPT_COLUMN_TYPES</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concept_instance_pair_table_name</span> <span class="o">=</span> <span class="n">CONCEPTINSTANCEPAIR_TABLE_NAME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concept_instance_pair_columns</span> <span class="o">=</span> <span class="n">CONCEPTINSTANCEPAIR_COLUMNS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concept_instance_pair_column_types</span> <span class="o">=</span> <span class="n">CONCEPTINSTANCEPAIR_COLUMN_TYPES</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span> <span class="o">=</span> <span class="n">RELATION_TABLE_NAME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relation_columns</span> <span class="o">=</span> <span class="n">RELATION_COLUMNS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relation_column_types</span> <span class="o">=</span> <span class="n">RELATION_COLUMN_TYPES</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cid2concept_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eid2cid_scores</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partial2cids_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hid&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

<div class="viewcode-block" id="ASERConceptConnection.init"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initialize the ASERConceptConnection, including creating tables, loading cids, eids, rids, and building cache</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">column_types</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_table_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">concept_instance_pair_table_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">],</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_columns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">concept_instance_pair_columns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_columns</span><span class="p">],</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_column_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">concept_instance_pair_column_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_column_types</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;Error: </span><span class="si">%s</span><span class="s2">_columns and </span><span class="si">%s</span><span class="s2">_column_types must be defined&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">column_types</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;memory&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_concept</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_table_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">concept_columns</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cid2concept_cache</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
                <span class="c1"># handle another cache</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2cids_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">cid</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_concept_instance_pair</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_instance_pair_table_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">concept_instance_pair_columns</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
                <span class="c1"># handle another cache</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">cid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">p</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">score</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">cid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">score</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">eid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eid2cid_scores</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">eid2cid_scores</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">p</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">score</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">eid2cid_scores</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">score</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_relation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_columns</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
                <span class="c1"># handle another cache</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_table_name</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_instance_pair_table_name</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;eid&quot;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;eid&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="ASERConceptConnection.close"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Close the ASERConceptConnection safely</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cids</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cid2concept_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eid2cid_scores</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2cids_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partial2cids_cache</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    KG (Concepts)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_convert_concept_to_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">})</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">concept_columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">concept</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">row</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">row</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">concept</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="k">def</span> <span class="nf">_convert_row_to_concept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">concept</span> <span class="o">=</span> <span class="n">ASERConcept</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">])</span>
        <span class="n">concept</span><span class="o">.</span><span class="n">cid</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">concept</span>

<div class="viewcode-block" id="ASERConceptConnection.get_concept_columns"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.get_concept_columns">[docs]</a>    <span class="k">def</span> <span class="nf">get_concept_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get column information from concepts</span>

<span class="sd">        :param columns: the columns to retrieve</span>
<span class="sd">        :type columns: List[str]</span>
<span class="sd">        :return: a list of retrieved rows</span>
<span class="sd">        :rtype: List[Dict[str, object]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_table_name</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_insert_concept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_concept_to_row</span><span class="p">(</span><span class="n">concept</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">insert_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_table_name</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;cache&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cid2concept_cache</span><span class="p">[</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">concept</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2cids_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">concept</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">v</span><span class="p">[</span><span class="n">concept</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v</span><span class="p">[</span><span class="n">concept</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">concept</span>

    <span class="k">def</span> <span class="nf">_insert_concepts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concepts</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_concept_to_row</span><span class="p">,</span> <span class="n">concepts</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">insert_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_table_name</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">concept</span> <span class="ow">in</span> <span class="n">concepts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;cache&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">concept</span> <span class="ow">in</span> <span class="n">concepts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cid2concept_cache</span><span class="p">[</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">concept</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2cids_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">concept</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="n">concept</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">concept</span> <span class="ow">in</span> <span class="n">concepts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cid2concept_cache</span><span class="p">[</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">concept</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2cids_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">concept</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="n">concept</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="n">concept</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">concepts</span>

    <span class="k">def</span> <span class="nf">_get_concept_and_store_in_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cid</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_concepts_and_store_in_cache</span><span class="p">([</span><span class="n">cid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_concepts_and_store_in_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cids</span><span class="p">):</span>
        <span class="n">concepts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_concept</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">select_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_table_name</span><span class="p">,</span> <span class="n">cids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">concept_columns</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">concept</span> <span class="ow">in</span> <span class="n">concepts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">concept</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cid2concept_cache</span><span class="p">[</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">concept</span>
                <span class="n">cached_eid_pattern_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cached_eid_pattern_scores</span><span class="p">:</span>
                    <span class="n">eid_pattern_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_rows_by_keys</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">concept_instance_pair_table_name</span><span class="p">,</span>
                        <span class="n">bys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cid&quot;</span><span class="p">],</span>
                        <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">],</span>
                        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;eid&quot;</span><span class="p">,</span> <span class="s2">&quot;pattern&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">cached_eid_pattern_scores</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;eid&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;pattern&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">eid_pattern_scores</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span><span class="p">[</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">cached_eid_pattern_scores</span>
                <span class="n">concept</span><span class="o">.</span><span class="n">instances</span> <span class="o">=</span> <span class="n">cached_eid_pattern_scores</span>
        <span class="k">return</span> <span class="n">concepts</span>

    <span class="k">def</span> <span class="nf">_update_concept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept</span><span class="p">):</span>
        <span class="c1"># append/update new instances</span>
        <span class="n">updated_concept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cid2concept_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">updated_concept</span><span class="p">:</span>  <span class="c1"># self.mode == &quot;memory&quot; or hit in cache</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
                <span class="n">updated_concept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_concept</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">select_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_table_name</span><span class="p">,</span> <span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">concept_columns</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">updated_concept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_concept_and_store_in_cache</span><span class="p">(</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">concept</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
            <span class="n">matched</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">updated_concept</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">matched</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
                <span class="n">updated_concept</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">update_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_update_op</span><span class="p">([</span><span class="s2">&quot;info&quot;</span><span class="p">],</span> <span class="s2">&quot;=&quot;</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_concept_to_row</span><span class="p">(</span><span class="n">updated_concept</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">update_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_table_name</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">update_op</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># don&quot;t care</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">updated_concept</span>

    <span class="k">def</span> <span class="nf">_update_concepts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concepts</span><span class="p">):</span>
        <span class="n">updated_concepts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">missed_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">missed_cids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">concept</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">concepts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">concept</span><span class="o">.</span><span class="n">cid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cids</span><span class="p">:</span>
                <span class="n">updated_concepts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">updated_concept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cid2concept_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">updated_concepts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">updated_concept</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">updated_concept</span><span class="p">:</span>
                    <span class="n">missed_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">missed_cids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">updated_concept</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_concept</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">select_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_table_name</span><span class="p">,</span> <span class="n">missed_cids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">concept_columns</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="n">updated_concepts</span><span class="p">[</span><span class="n">missed_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">updated_concept</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">updated_concept</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_concepts_and_store_in_cache</span><span class="p">(</span><span class="n">missed_cids</span><span class="p">)):</span>
                <span class="n">updated_concepts</span><span class="p">[</span><span class="n">missed_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">updated_concept</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">concept</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">concepts</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">updated_concepts</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
                <span class="n">updated_concepts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">concept</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">updated_concept</span> <span class="o">=</span> <span class="n">updated_concepts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">concept</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
                    <span class="n">matched</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">updated_concept</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="n">matched</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
                        <span class="n">updated_concept</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">update_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_update_op</span><span class="p">([</span><span class="s2">&quot;info&quot;</span><span class="p">],</span> <span class="s2">&quot;=&quot;</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_concept_to_row</span><span class="p">,</span> <span class="n">updated_concepts</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">update_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_table_name</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">update_op</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">concepts</span><span class="p">)</span>  <span class="c1"># don&quot;t care</span>
        <span class="k">return</span> <span class="n">updated_concepts</span>

<div class="viewcode-block" id="ASERConceptConnection.insert_concept"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.insert_concept">[docs]</a>    <span class="k">def</span> <span class="nf">insert_concept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Insert/Update a concept into ASER</span>
<span class="sd">        (suggestion: consider to use `insert_concepts` if you want to insert multiple concepts)</span>

<span class="sd">        :param concept: a concept to insert/update</span>
<span class="sd">        :type concept: aser.concept.ASERConcept</span>
<span class="sd">        :return: the inserted/updated concept</span>
<span class="sd">        :rtype: aser.concept.ASERConcept</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">concept</span><span class="o">.</span><span class="n">cid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cids</span><span class="p">:</span>
            <span class="n">concept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_concept</span><span class="p">(</span><span class="n">concept</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">concept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_concept</span><span class="p">(</span><span class="n">concept</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">concept</span></div>

<div class="viewcode-block" id="ASERConceptConnection.insert_concepts"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.insert_concepts">[docs]</a>    <span class="k">def</span> <span class="nf">insert_concepts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concepts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Insert/Update concepts into ASER</span>

<span class="sd">        :param concepts: concepts to insert/update</span>
<span class="sd">        :type concepts: List[aser.concept.ASERConcept]</span>
<span class="sd">        :return: the inserted/updated concepts</span>
<span class="sd">        :rtype: List[aser.concept.ASERConcept]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_concepts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">existing_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">existing_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">existing_concepts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">concept</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">concepts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">concept</span><span class="o">.</span><span class="n">cid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cids</span><span class="p">:</span>
                <span class="n">new_concepts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concept</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concept</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">existing_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">existing_concepts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concept</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_concepts</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insert_concepts</span><span class="p">(</span><span class="n">new_concepts</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing_concepts</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">updated_concept</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_concepts</span><span class="p">(</span><span class="n">existing_concepts</span><span class="p">)):</span>
                <span class="n">results</span><span class="p">[</span><span class="n">existing_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">updated_concept</span>

        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="ASERConceptConnection.get_exact_match_concept"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.get_exact_match_concept">[docs]</a>    <span class="k">def</span> <span class="nf">get_exact_match_concept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve a exact matched concept from ASER</span>
<span class="sd">        (suggestion: consider to use `get_exact_match_concepts` if you want to retrieve multiple concepts)</span>

<span class="sd">        :param concept: a concept that contains the cid</span>
<span class="sd">        :type concept: Union[aser.concept.ASERConcept, Dict[str, object], str]</span>
<span class="sd">        :return: the exact matched concept</span>
<span class="sd">        :rtype: aser.concept.ASERConcept</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">concept</span><span class="p">,</span> <span class="n">ASERConcept</span><span class="p">):</span>
            <span class="n">cid</span> <span class="o">=</span> <span class="n">concept</span><span class="o">.</span><span class="n">cid</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">concept</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">cid</span> <span class="o">=</span> <span class="n">concept</span><span class="p">[</span><span class="s2">&quot;cid&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">concept</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">cid</span> <span class="o">=</span> <span class="n">concept</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: conceptualize should be an instance of ASERConcept, a dictionary, or a cid.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cids</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">exact_match_concept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cid2concept_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exact_match_concept</span><span class="p">:</span>
            <span class="n">exact_match_concept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_concept_and_store_in_cache</span><span class="p">(</span><span class="n">cid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">exact_match_concept</span></div>

<div class="viewcode-block" id="ASERConceptConnection.get_exact_match_concepts"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.get_exact_match_concepts">[docs]</a>    <span class="k">def</span> <span class="nf">get_exact_match_concepts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concepts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve multiple exact matched concepts from ASER</span>

<span class="sd">        :param concepts: concepts</span>
<span class="sd">        :type concepts: Union[List[aser.concept.ASERConcept], List[Dict[str, object]], List[str]]</span>
<span class="sd">        :return: the exact matched concepts</span>
<span class="sd">        :rtype: List[aser.concept.ASERConcept]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">exact_match_concepts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">concepts</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">concepts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ASERConcept</span><span class="p">):</span>
                <span class="n">cids</span> <span class="o">=</span> <span class="p">[</span><span class="n">concept</span><span class="o">.</span><span class="n">cid</span> <span class="k">for</span> <span class="n">concept</span> <span class="ow">in</span> <span class="n">concepts</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">concepts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">cids</span> <span class="o">=</span> <span class="p">[</span><span class="n">concept</span><span class="p">[</span><span class="s2">&quot;cid&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">concept</span> <span class="ow">in</span> <span class="n">concepts</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">concepts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">cids</span> <span class="o">=</span> <span class="n">concepts</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: concepts should instances of ASERConcept, dictionaries, or cids.&quot;</span><span class="p">)</span>

            <span class="n">missed_indices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">missed_cids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cids</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">cid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cids</span><span class="p">:</span>
                    <span class="n">exact_match_concepts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">exact_match_concept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cid2concept_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">exact_match_concepts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exact_match_concept</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exact_match_concept</span><span class="p">:</span>
                    <span class="n">missed_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">missed_cids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">exact_match_concept</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_concepts_and_store_in_cache</span><span class="p">(</span><span class="n">missed_cids</span><span class="p">)):</span>
                <span class="n">exact_match_concepts</span><span class="p">[</span><span class="n">missed_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">exact_match_concept</span>
        <span class="k">return</span> <span class="n">exact_match_concepts</span></div>

<div class="viewcode-block" id="ASERConceptConnection.get_concepts_by_keys"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.get_concepts_by_keys">[docs]</a>    <span class="k">def</span> <span class="nf">get_concepts_by_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bys</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">order_bys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve multiple partial matched concepts by keys and values from ASER</span>

<span class="sd">        :param bys: the given columns to match</span>
<span class="sd">        :type bys: List[str]</span>
<span class="sd">        :param keys: the given values to match</span>
<span class="sd">        :type keys: List[str]</span>
<span class="sd">        :param order_bys: the columns whose value are used to sort rows</span>
<span class="sd">        :type order_bys: List[str]</span>
<span class="sd">        :param reverse: whether to sort in a reversed order</span>
<span class="sd">        :type reverse: bool</span>
<span class="sd">        :param top_n: how many concepts to return, default `None` for all concepts</span>
<span class="sd">        :type top_n: int</span>
<span class="sd">        :return: the partial matched concepts</span>
<span class="sd">        :rtype: List[aser.concept.Concepts]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bys</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bys</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">bys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">concept_columns</span><span class="p">:</span>
                <span class="n">bys</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_concept</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_rows_by_keys</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">concept_table_name</span><span class="p">,</span>
                    <span class="n">bys</span><span class="p">,</span>
                    <span class="n">keys</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">concept_columns</span><span class="p">,</span>
                    <span class="n">order_bys</span><span class="o">=</span><span class="n">order_bys</span><span class="p">,</span>
                    <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">,</span>
                    <span class="n">top_n</span><span class="o">=</span><span class="n">top_n</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ASERConceptConnection.get_concept_given_str"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.get_concept_given_str">[docs]</a>    <span class="k">def</span> <span class="nf">get_concept_given_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept_str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve the exact matched concept given a string from ASER</span>

<span class="sd">        :param concept_str: a string representation of a concept</span>
<span class="sd">        :type concept_str: str</span>
<span class="sd">        :return: the exact matched concept</span>
<span class="sd">        :rtype: aser.concept.ASERConcept</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cid</span> <span class="o">=</span> <span class="n">ASERConcept</span><span class="o">.</span><span class="n">generate_cid</span><span class="p">(</span><span class="n">concept_str</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_match_concept</span><span class="p">(</span><span class="n">cid</span><span class="p">)</span></div>

<div class="viewcode-block" id="ASERConceptConnection.get_concepts_given_strs"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.get_concepts_given_strs">[docs]</a>    <span class="k">def</span> <span class="nf">get_concepts_given_strs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept_strs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve the exact matched concepts given strings from ASER</span>

<span class="sd">        :param concept_str: string representations of concepts</span>
<span class="sd">        :type concept_str: List[str]</span>
<span class="sd">        :return: the exact matched concepts</span>
<span class="sd">        :rtype: List[aser.concept.ASERConcept]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ASERConcept</span><span class="o">.</span><span class="n">generate_cid</span><span class="p">,</span> <span class="n">concept_strs</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_match_concepts</span><span class="p">(</span><span class="n">cids</span><span class="p">)</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    KG (Relations)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_convert_relation_to_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">})</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">relation_senses</span><span class="p">)]:</span>
            <span class="n">row</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relation_senses</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">relation</span><span class="o">.</span><span class="n">relations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="k">def</span> <span class="nf">_convert_row_to_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Relation</span><span class="p">(</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;tid&quot;</span><span class="p">],</span> <span class="p">{</span><span class="n">r</span><span class="p">:</span> <span class="n">cnt</span>
                                     <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cnt</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">}</span>
        <span class="p">)</span>

<div class="viewcode-block" id="ASERConceptConnection.get_relation_columns"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.get_relation_columns">[docs]</a>    <span class="k">def</span> <span class="nf">get_relation_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get column information from relations</span>

<span class="sd">        :param columns: the columns to retrieve</span>
<span class="sd">        :type columns: List[str]</span>
<span class="sd">        :return: a list of retrieved rows</span>
<span class="sd">        :rtype: List[Dict[str, object]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_insert_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_relation_to_row</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">insert_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;cache&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">relation</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">v</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">relation</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">v</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">relation</span>

    <span class="k">def</span> <span class="nf">_insert_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relations</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_relation_to_row</span><span class="p">,</span> <span class="n">relations</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">insert_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;cache&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">relation</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">relation</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">relations</span>

    <span class="k">def</span> <span class="nf">_get_relation_and_store_in_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rid</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relations_and_store_in_cache</span><span class="p">([</span><span class="n">rid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_relations_and_store_in_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rids</span><span class="p">):</span>
        <span class="n">relations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_relation</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">select_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span> <span class="n">rids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_columns</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">relation</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">relation</span>
        <span class="k">return</span> <span class="n">relations</span>

    <span class="k">def</span> <span class="nf">_update_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation</span><span class="p">):</span>
        <span class="c1"># find new relation frequencies</span>
        <span class="n">update_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relation_senses</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">relation</span><span class="o">.</span><span class="n">relations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">update_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># update db</span>
        <span class="n">update_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_update_op</span><span class="p">(</span><span class="n">update_columns</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_relation_to_row</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">update_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">update_op</span><span class="p">,</span> <span class="n">update_columns</span><span class="p">)</span>

        <span class="c1"># update cache</span>
        <span class="n">updated_relation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">updated_relation</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">update_columns</span><span class="p">:</span>
                <span class="n">updated_relation</span><span class="o">.</span><span class="n">relation</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">+=</span> <span class="n">relation</span><span class="o">.</span><span class="n">relation</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">updated_relation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relation_and_store_in_cache</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">updated_relation</span>

    <span class="k">def</span> <span class="nf">_update_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relations</span><span class="p">):</span>
        <span class="c1"># update db</span>
        <span class="n">update_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_update_op</span><span class="p">(</span><span class="n">relation_senses</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_relation_to_row</span><span class="p">,</span> <span class="n">relations</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">update_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">update_op</span><span class="p">,</span> <span class="n">relation_senses</span><span class="p">)</span>

        <span class="c1"># update cache</span>
        <span class="n">updated_relations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">missed_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">missed_rids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">relation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">relations</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">relation</span><span class="o">.</span><span class="n">rid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="p">:</span>
                <span class="n">updated_relations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">updated_relation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">updated_relations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">updated_relations</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">updated_relation</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relation_senses</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">updated_relation</span><span class="o">.</span><span class="n">relations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">updated_relation</span><span class="o">.</span><span class="n">relations</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">+=</span> <span class="n">relation</span><span class="o">.</span><span class="n">relations</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">missed_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">missed_rids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">updated_relation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_relations_and_store_in_cache</span><span class="p">(</span><span class="n">missed_rids</span><span class="p">)):</span>
            <span class="n">updated_relations</span><span class="p">[</span><span class="n">missed_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">updated_relation</span>
        <span class="k">return</span> <span class="n">updated_relations</span>

<div class="viewcode-block" id="ASERConceptConnection.insert_relation"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.insert_relation">[docs]</a>    <span class="k">def</span> <span class="nf">insert_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Insert/Update a relation into ASER</span>
<span class="sd">        (suggestion: consider to use `insert_relations` if you want to insert multiple relations)</span>

<span class="sd">        :param relation: a relation to insert/update</span>
<span class="sd">        :type relation: aser.relation.Relation</span>
<span class="sd">        :return: the inserted/updated relation</span>
<span class="sd">        :rtype: aser.relation.Relation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">relation</span><span class="o">.</span><span class="n">rid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_relation</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_relation</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span></div>

<div class="viewcode-block" id="ASERConceptConnection.insert_relations"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.insert_relations">[docs]</a>    <span class="k">def</span> <span class="nf">insert_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Insert/Update relations into ASER</span>

<span class="sd">        :param relations: relations to insert/update</span>
<span class="sd">        :type relations: List[aser.relation.Relation]</span>
<span class="sd">        :return: the inserted/updated relations</span>
<span class="sd">        :rtype: List[aser.relation.Relation]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_relations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">existing_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">existing_relations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">relation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">relations</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">relation</span><span class="o">.</span><span class="n">rid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="p">:</span>
                <span class="n">new_relations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">existing_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">existing_relations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_relations</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insert_relations</span><span class="p">(</span><span class="n">new_relations</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing_relations</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">updated_relation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_relations</span><span class="p">(</span><span class="n">existing_relations</span><span class="p">)):</span>
                <span class="n">results</span><span class="p">[</span><span class="n">existing_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">updated_relation</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="ASERConceptConnection.get_exact_match_relation"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.get_exact_match_relation">[docs]</a>    <span class="k">def</span> <span class="nf">get_exact_match_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve an exact matched relation from ASER</span>
<span class="sd">        (suggestion: consider to use `get_exact_match_relations` if you want to retrieve multiple relations)</span>

<span class="sd">        :param relation: a relation that contains the rid or a concept pair that contains two cids</span>
<span class="sd">        :type relation: Union[aser.relation.Relation, Dict[str, object], str, Tuple[aser.concept.ASERConcept, aser.concept.ASERConcept], Tuple[str, str]]</span>
<span class="sd">        :return: the exact matched relation</span>
<span class="sd">        :rtype: aser.relation.Relation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="n">Relation</span><span class="p">):</span>
            <span class="n">rid</span> <span class="o">=</span> <span class="n">relation</span><span class="o">.</span><span class="n">rid</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">rid</span> <span class="o">=</span> <span class="n">relation</span><span class="p">[</span><span class="s2">&quot;rid&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">rid</span> <span class="o">=</span> <span class="n">relation</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ASERConcept</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ASERConcept</span><span class="p">):</span>
                <span class="n">rid</span> <span class="o">=</span> <span class="n">Relation</span><span class="o">.</span><span class="n">generate_rid</span><span class="p">(</span><span class="n">relation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="n">relation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">rid</span> <span class="o">=</span> <span class="n">Relation</span><span class="o">.</span><span class="n">generate_rid</span><span class="p">(</span><span class="n">relation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">relation</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Error: relation should be (an instance of ASERConcept, an instance of ASERConcept) or (hid, tid).&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Error: relation should be an instance of Relation, a dictionary, rid,&quot;</span>
                <span class="s2">&quot;(an instance of ASERConcept, an instance of ASERConcept), or (hid, tid).&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">rid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">exact_match_relation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exact_match_relation</span><span class="p">:</span>
            <span class="n">exact_match_relation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relation_and_store_in_cache</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">exact_match_relation</span></div>

<div class="viewcode-block" id="ASERConceptConnection.get_exact_match_relations"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.get_exact_match_relations">[docs]</a>    <span class="k">def</span> <span class="nf">get_exact_match_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve exact matched relations from ASER</span>

<span class="sd">        :param relations: a relations that contain the rids or concept pairs each of which contains two cids</span>
<span class="sd">        :type relations: Union[List[aser.relation.Relation], List[Dict[str, object]], List[str], List[Tuple[aser.concept.ASERConcept, aser.concept.ASERConcept]], List[Tuple[str, str]]]</span>
<span class="sd">        :return: the exact matched relations</span>
<span class="sd">        :rtype: List[aser.relation.Relation]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">exact_match_relations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">relations</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Relation</span><span class="p">):</span>
                <span class="n">rids</span> <span class="o">=</span> <span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span> <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">rids</span> <span class="o">=</span> <span class="p">[</span><span class="n">relation</span><span class="p">[</span><span class="s2">&quot;rid&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">rids</span> <span class="o">=</span> <span class="n">relations</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">relations</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ASERConcept</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">ASERConcept</span><span class="p">):</span>
                    <span class="n">rids</span> <span class="o">=</span> <span class="p">[</span><span class="n">Relation</span><span class="o">.</span><span class="n">generate_rid</span><span class="p">(</span><span class="n">relation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="n">relation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span> <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">rids</span> <span class="o">=</span> <span class="p">[</span><span class="n">Relation</span><span class="o">.</span><span class="n">generate_rid</span><span class="p">(</span><span class="n">relation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">relation</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Error: relations should be [(an instance of ASERConcept, an instance of ASERConcept), ...] or [(hid, tid), ...].&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Error: relations should be instances of Relation, dictionaries, rids, [(an instance of ASERConcept, an instance of ASERConcept), ...], or [(hid, tid), ...].&quot;</span>
                <span class="p">)</span>

            <span class="n">missed_indices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">missed_rids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">rid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rids</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">rid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rids</span><span class="p">:</span>
                    <span class="n">exact_match_relations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">exact_match_relation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">exact_match_relations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exact_match_relation</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exact_match_relation</span><span class="p">:</span>
                    <span class="n">missed_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">missed_rids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">exact_match_relation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_relations_and_store_in_cache</span><span class="p">(</span><span class="n">missed_rids</span><span class="p">)):</span>
                <span class="n">exact_match_relations</span><span class="p">[</span><span class="n">missed_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">exact_match_relation</span>
        <span class="k">return</span> <span class="n">exact_match_relations</span></div>

<div class="viewcode-block" id="ASERConceptConnection.get_relations_by_keys"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.get_relations_by_keys">[docs]</a>    <span class="k">def</span> <span class="nf">get_relations_by_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bys</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">order_bys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve multiple partial matched relations by keys and values from ASER</span>

<span class="sd">        :param bys: the given columns to match</span>
<span class="sd">        :type bys: List[str]</span>
<span class="sd">        :param keys: the given values to match</span>
<span class="sd">        :type keys: List[str]</span>
<span class="sd">        :param order_bys: the columns whose value are used to sort rows</span>
<span class="sd">        :type order_bys: Union[List[str], None] (default = None)</span>
<span class="sd">        :param reverse: whether to sort in a reversed order</span>
<span class="sd">        :type reverse: bool (default = False)</span>
<span class="sd">        :param top_n: how many relations to return, default `None` for all relations</span>
<span class="sd">        :type top_n: Union[int, None] (default = None)</span>
<span class="sd">        :return: the partial matched relations</span>
<span class="sd">        :rtype: List[aser.relation.Relation]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bys</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bys</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">bys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_columns</span><span class="p">:</span>
                <span class="n">bys</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">by_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">,</span> <span class="s2">&quot;tid&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">bys</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">:</span>
                <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">by_index</span> <span class="o">=</span> <span class="n">bys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">keys</span><span class="p">[</span><span class="n">by_index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
                <span class="n">key_match_relations</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="n">by_index</span><span class="p">]]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[]</span>
                <span class="n">key_cache</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">key_match_relations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_relation</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_rows_by_keys</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span> <span class="p">[</span><span class="n">bys</span><span class="p">[</span><span class="n">by_index</span><span class="p">]],</span> <span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="n">by_index</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_columns</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">key_match_relation</span> <span class="ow">in</span> <span class="n">key_match_relations</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key_match_relation</span><span class="o">.</span><span class="n">rid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">rid2relation_cache</span><span class="p">[</span><span class="n">key_match_relation</span><span class="o">.</span><span class="n">rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_match_relation</span>
                    <span class="n">key_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key_match_relation</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span>
                <span class="n">cache</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="n">by_index</span><span class="p">]]</span> <span class="o">=</span> <span class="n">key_cache</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bys</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">by_index</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">key_match_relations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">bys</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">key_match_relations</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">order_bys</span><span class="p">:</span>
                <span class="n">key_match_relations</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="n">order_bys</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">top_n</span><span class="p">:</span>
                <span class="n">key_match_relations</span> <span class="o">=</span> <span class="n">key_match_relations</span><span class="p">[:</span><span class="n">top_n</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">key_match_relations</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_relation</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_rows_by_keys</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">relation_table_name</span><span class="p">,</span>
                    <span class="n">bys</span><span class="p">,</span>
                    <span class="n">keys</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">relation_columns</span><span class="p">,</span>
                    <span class="n">order_bys</span><span class="o">=</span><span class="n">order_bys</span><span class="p">,</span>
                    <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">,</span>
                    <span class="n">top_n</span><span class="o">=</span><span class="n">top_n</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    KG (ConceptInstancePairs)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_convert_concept_instance_pair_to_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="p">,</span> <span class="n">ASERConceptInstancePair</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span>
                    <span class="s2">&quot;cid&quot;</span><span class="p">:</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span>
                    <span class="s2">&quot;eid&quot;</span><span class="p">:</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span>
                    <span class="s2">&quot;pattern&quot;</span><span class="p">:</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span>
                    <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">score</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="n">ASERConceptInstancePair</span><span class="o">.</span><span class="n">generate_pid</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span>
                    <span class="s2">&quot;cid&quot;</span><span class="p">:</span> <span class="n">concept_instance_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span>
                    <span class="s2">&quot;eid&quot;</span><span class="p">:</span> <span class="n">concept_instance_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span>
                    <span class="s2">&quot;pattern&quot;</span><span class="p">:</span> <span class="n">concept_instance_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span>
                    <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">concept_instance_pair</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="k">def</span> <span class="nf">_convert_row_to_concept_instance_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ASERConceptInstancePair</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;cid&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;eid&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;pattern&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">])</span>

<div class="viewcode-block" id="ASERConceptConnection.get_concept_instance_pair_columns"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.get_concept_instance_pair_columns">[docs]</a>    <span class="k">def</span> <span class="nf">get_concept_instance_pair_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get column information from concepts</span>

<span class="sd">        :param columns: the columns to retrieve</span>
<span class="sd">        :type columns: List[str]</span>
<span class="sd">        :return: a list of retrieved rows</span>
<span class="sd">        :rtype: List[Dict[str, object]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_instance_pair_columns</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_insert_concept_instance_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_concept_instance_pair_to_row</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">insert_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_instance_pair_table_name</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;cache&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span><span class="p">[</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eid2cid_scores</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eid2cid_scores</span><span class="p">[</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span><span class="p">[</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span><span class="p">[</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eid2cid_scores</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eid2cid_scores</span><span class="p">[</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eid2cid_scores</span><span class="p">[</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_concept_instance_pair</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_insert_concept_instance_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept_instance_pairs</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_concept_instance_pair_to_row</span><span class="p">,</span> <span class="n">concept_instance_pairs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">insert_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_instance_pair_table_name</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">concept_instance_pair</span> <span class="ow">in</span> <span class="n">concept_instance_pairs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;cache&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">concept_instance_pair</span> <span class="ow">in</span> <span class="n">concept_instance_pairs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span><span class="p">[</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eid2cid_scores</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">eid2cid_scores</span><span class="p">[</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
                    <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">concept_instance_pair</span> <span class="ow">in</span> <span class="n">concept_instance_pairs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span><span class="p">[</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span><span class="p">[</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eid2cid_scores</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">eid2cid_scores</span><span class="p">[</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">eid2cid_scores</span><span class="p">[</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_row_to_concept_instance_pair</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_update_concept_instance_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="p">):</span>
        <span class="c1"># update db</span>
        <span class="n">update_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_update_op</span><span class="p">([</span><span class="s2">&quot;score&quot;</span><span class="p">],</span> <span class="s2">&quot;+&quot;</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_concept_instance_pair_to_row</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">update_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_instance_pair_table_name</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">update_op</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">])</span>

        <span class="c1"># updata cache</span>
        <span class="n">updated_score</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># don&quot;t care</span>
        <span class="n">cached_cid_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eid2cid_scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_cid_scores</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cid_score</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cached_cid_scores</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span> <span class="o">==</span> <span class="n">cid_score</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">updated_score</span> <span class="o">=</span> <span class="n">cid_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">score</span>
                    <span class="n">cached_cid_scores</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cid_score</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">updated_score</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="n">cached_eid_pattern_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_eid_pattern_scores</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">eid_pattern_score</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cached_eid_pattern_scores</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span> <span class="o">==</span> <span class="n">eid_pattern_score</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">updated_score</span> <span class="o">=</span> <span class="n">eid_pattern_score</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">score</span>
                    <span class="n">cached_eid_pattern_scores</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">eid_pattern_score</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">eid_pattern_score</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">updated_score</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">updated_score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">updated_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">select_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_instance_pair_table_name</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">])[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ASERConceptInstancePair</span><span class="p">(</span>
            <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span> <span class="n">updated_score</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_concept_instance_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept_instance_pairs</span><span class="p">):</span>
        <span class="c1"># update db</span>
        <span class="n">update_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_update_op</span><span class="p">([</span><span class="s2">&quot;score&quot;</span><span class="p">],</span> <span class="s2">&quot;+&quot;</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_concept_instance_pair_to_row</span><span class="p">,</span> <span class="n">concept_instance_pairs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">update_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_instance_pair_table_name</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">update_op</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">])</span>

        <span class="c1"># update cache</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">concept_instance_pairs</span><span class="p">)</span>  <span class="c1"># don&quot;t care</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">updated_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">missed_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">missed_pids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">concept_instance_pair</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">concept_instance_pairs</span><span class="p">):</span>
            <span class="n">cached_cid_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eid2cid_scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached_cid_scores</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cid_score</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cached_cid_scores</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span> <span class="o">==</span> <span class="n">cid_score</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">updated_score</span> <span class="o">=</span> <span class="n">cid_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">score</span>
                        <span class="n">cached_cid_scores</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cid_score</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">updated_score</span><span class="p">)</span>
                        <span class="k">break</span>
            <span class="n">cached_eid_pattern_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached_eid_pattern_scores</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">eid_pattern_score</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cached_eid_pattern_scores</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span> <span class="o">==</span> <span class="n">eid_pattern_score</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">updated_score</span> <span class="o">=</span> <span class="n">eid_pattern_score</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">score</span>
                        <span class="n">cached_eid_pattern_scores</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">eid_pattern_score</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">eid_pattern_score</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">updated_score</span><span class="p">)</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">updated_score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">missed_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">updated_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">missed_pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">updated_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">updated_score</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missed_indices</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">updated_row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">select_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concept_instance_pair_table_name</span><span class="p">,</span> <span class="n">missed_pids</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="n">updated_scores</span><span class="p">[</span><span class="n">missed_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">updated_row</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">ASERConceptInstancePair</span><span class="p">(</span>
                <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span> <span class="n">updated_score</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">concept_instance_pair</span><span class="p">,</span> <span class="n">updated_score</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">concept_instance_pairs</span><span class="p">,</span> <span class="n">updated_score</span><span class="p">)</span>
        <span class="p">]</span>

<div class="viewcode-block" id="ASERConceptConnection.insert_concept_instance_pair"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.insert_concept_instance_pair">[docs]</a>    <span class="k">def</span> <span class="nf">insert_concept_instance_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept_instance_pair</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert/Update a concept_instance_pair into ASER</span>
<span class="sd">        (suggestion: consider to use `insert_concept_instance_pairs` if you want to insert multiple pairs)</span>

<span class="sd">        :param concept_instance_pair: a concept-instance pair to insert/update</span>
<span class="sd">        :type concept_instance_pair: Union[aser.concept.ASERConceptInstancePair, Tuple[aser.concept.ASERConcpet, aser.event.Eventuality, float]]</span>
<span class="sd">        :return: the inserted/updated concept-instance pair</span>
<span class="sd">        :rtype: aser.concept.ASERConceptInstancePair</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="p">,</span> <span class="n">ASERConceptInstancePair</span><span class="p">):</span>
            <span class="n">concept_instance_pair</span> <span class="o">=</span> <span class="n">ASERConceptInstancePair</span><span class="p">(</span>
                <span class="n">concept_instance_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span>
                <span class="n">concept_instance_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span>
                <span class="n">concept_instance_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span>
                <span class="n">concept_instance_pair</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cids</span> <span class="ow">and</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_concept_instance_pair</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_concept_instance_pair</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="p">)</span></div>

<div class="viewcode-block" id="ASERConceptConnection.insert_concept_instance_pairs"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.insert_concept_instance_pairs">[docs]</a>    <span class="k">def</span> <span class="nf">insert_concept_instance_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept_instance_pairs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert/Update concept_instance_pairs into ASER</span>

<span class="sd">        :param concept_instance_pairs: concept-instance pairs to insert/update</span>
<span class="sd">        :type concept_instance_pairs: Union[List[aser.concept.ASERConceptInstancePair], List[Tuple[aser.concept.ASERConcpet, aser.event.Eventuality, float]]]</span>
<span class="sd">        :return: the inserted/updated concept-instance pairs</span>
<span class="sd">        :rtype: List[aser.concept.ASERConceptInstancePair]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">concept_instance_pairs</span><span class="p">)</span>
        <span class="n">new_concept_instance_pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">existing_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">existing_concept_instance_pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">concept_instance_pair</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">concept_instance_pairs</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="p">,</span> <span class="n">ASERConceptInstancePair</span><span class="p">):</span>
                <span class="n">concept_instance_pair</span> <span class="o">=</span> <span class="n">ASERConceptInstancePair</span><span class="p">(</span>
                    <span class="n">concept_instance_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span>
                    <span class="n">concept_instance_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span>
                    <span class="n">concept_instance_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span>
                    <span class="n">concept_instance_pair</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">cid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cids</span> <span class="ow">and</span> <span class="n">concept_instance_pair</span><span class="o">.</span><span class="n">eid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="p">:</span>
                <span class="n">existing_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">existing_concept_instance_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_concept_instance_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concept_instance_pair</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_concept_instance_pairs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insert_concept_instance_pairs</span><span class="p">(</span><span class="n">new_concept_instance_pairs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing_indices</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">updated_pair</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_concept_instance_pairs</span><span class="p">(</span><span class="n">existing_concept_instance_pairs</span><span class="p">)):</span>
                <span class="n">results</span><span class="p">[</span><span class="n">existing_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">updated_pair</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="ASERConceptConnection.get_eventualities_given_concept"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.get_eventualities_given_concept">[docs]</a>    <span class="k">def</span> <span class="nf">get_eventualities_given_concept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve original eventualities given a concept from ASER</span>

<span class="sd">        :param concept: concept that corresponds to some eventualities</span>
<span class="sd">        :type concept: Union[aser.concept.ASERConcpet, Dict[str, object], str]</span>
<span class="sd">        :return: the linked eventualities</span>
<span class="sd">        :rtype: List[aser.eventuality.Eventuality]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">concept</span><span class="p">,</span> <span class="n">ASERConcept</span><span class="p">):</span>
            <span class="n">cid</span> <span class="o">=</span> <span class="n">concept</span><span class="o">.</span><span class="n">cid</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">concept</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">cid</span> <span class="o">=</span> <span class="n">concept</span><span class="p">[</span><span class="s2">&quot;cid&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">concept</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">cid</span> <span class="o">=</span> <span class="n">concept</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: conceptualize should be an instance of ASERConcept, a dictionary, or a cid.&quot;</span><span class="p">)</span>

        <span class="n">cached_eid_pattern_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cid2eid_pattern_scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_eid_pattern_scores</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cached_eid_pattern_scores</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eid_pattern_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_rows_by_keys</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">concept_instance_pair_table_name</span><span class="p">,</span> <span class="n">bys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cid&quot;</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">cid</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;eid&quot;</span><span class="p">,</span> <span class="s2">&quot;pattern&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">eid_pattern_scores</span></div>

<div class="viewcode-block" id="ASERConceptConnection.get_concepts_given_eventuality"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.get_concepts_given_eventuality">[docs]</a>    <span class="k">def</span> <span class="nf">get_concepts_given_eventuality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventuality</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve concepts given an eventuality from ASER</span>

<span class="sd">        :param eventuality: eventuality that conceptualizes to the given concept</span>
<span class="sd">        :type eventuality: Union[aser.eventuality.Eventuality, Dict[str, object], str]</span>
<span class="sd">        :return: the linked concepts</span>
<span class="sd">        :rtype: List[aser.concept.ASERConcepts]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eventuality</span><span class="p">,</span> <span class="n">Eventuality</span><span class="p">):</span>
            <span class="n">eid</span> <span class="o">=</span> <span class="n">eventuality</span><span class="o">.</span><span class="n">eid</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eventuality</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">eid</span> <span class="o">=</span> <span class="n">eventuality</span><span class="p">[</span><span class="s2">&quot;eid&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eventuality</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">eid</span> <span class="o">=</span> <span class="n">eventuality</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: conceptualize should be an instance of Eventuality, a dictionary, or a eid.&quot;</span><span class="p">)</span>

        <span class="n">cached_cid_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eid2cid_scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_cid_scores</span><span class="p">:</span>
            <span class="n">cids</span> <span class="o">=</span> <span class="p">[</span><span class="n">cid_score</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">cid_score</span> <span class="ow">in</span> <span class="n">cached_cid_scores</span><span class="p">]</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">cid_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">cid_score</span> <span class="ow">in</span> <span class="n">cached_cid_scores</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cid_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">get_rows_by_keys</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">concept_instance_pair_table_name</span><span class="p">,</span> <span class="n">bys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;eid&quot;</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">eid</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cid&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">cids</span> <span class="o">=</span> <span class="p">[</span><span class="n">cid_score</span><span class="p">[</span><span class="s2">&quot;cid&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cid_score</span> <span class="ow">in</span> <span class="n">cid_scores</span><span class="p">]</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">cid_score</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cid_score</span> <span class="ow">in</span> <span class="n">cid_scores</span><span class="p">]</span>
        <span class="n">concepts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_match_concepts</span><span class="p">(</span><span class="n">cids</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">concepts</span><span class="p">,</span> <span class="n">scores</span><span class="p">))</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Additional APIs</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ASERConceptConnection.get_related_concepts"><a class="viewcode-back" href="../../../api/database.html#aser.database.kg_connection.ASERConceptConnection.get_related_concepts">[docs]</a>    <span class="k">def</span> <span class="nf">get_related_concepts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve related (connected) concepts from ASER</span>

<span class="sd">        :param eventuality: a concept that contains the eid</span>
<span class="sd">        :type concept: Union[aser.concept.ASERConcept, Dict[str, object], str]</span>
<span class="sd">        :return: the related concepts</span>
<span class="sd">        :rtype: List[Tuple[aser.concept.ASERConcept, aser.relation.Relation]]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">concept</span><span class="p">,</span> <span class="n">ASERConcept</span><span class="p">):</span>
            <span class="n">cid</span> <span class="o">=</span> <span class="n">concept</span><span class="o">.</span><span class="n">cid</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">concept</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">cid</span> <span class="o">=</span> <span class="n">concept</span><span class="p">[</span><span class="s2">&quot;cid&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">concept</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">cid</span> <span class="o">=</span> <span class="n">concept</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: conceptualize should be an instance of ASERConcept, a dictionary, or a cid.&quot;</span><span class="p">)</span>

        <span class="c1"># cid == hid</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;hid&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">:</span>
                <span class="n">related_rids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="nb">list</span><span class="p">())</span>
                <span class="n">related_relations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_match_relations</span><span class="p">(</span><span class="n">related_rids</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">related_relations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relations_by_keys</span><span class="p">(</span><span class="n">bys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span>
            <span class="n">tids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">tid</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">related_relations</span><span class="p">]</span>
            <span class="n">t_concepts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_match_concepts</span><span class="p">(</span><span class="n">tids</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;cache&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;hid&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">]:</span>  <span class="c1"># hit</span>
                    <span class="n">related_rids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="nb">list</span><span class="p">())</span>
                    <span class="n">related_relations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_match_relations</span><span class="p">(</span><span class="n">related_rids</span><span class="p">)</span>
                    <span class="n">tids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">tid</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">related_relations</span><span class="p">]</span>
                    <span class="n">t_concepts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_match_concepts</span><span class="p">(</span><span class="n">tids</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># miss</span>
                    <span class="n">related_relations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relations_by_keys</span><span class="p">(</span><span class="n">bys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span>
                    <span class="n">tids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">tid</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">related_relations</span><span class="p">]</span>
                    <span class="n">t_concepts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_match_concepts</span><span class="p">(</span><span class="n">tids</span><span class="p">)</span>
                    <span class="c1"># update cache</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">partial2rids_cache</span><span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">][</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">relation</span><span class="o">.</span><span class="n">rid</span> <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">related_relations</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">related_relations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relations_by_keys</span><span class="p">(</span><span class="n">bys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span>
                <span class="n">tids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">tid</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">related_relations</span><span class="p">]</span>
                <span class="n">t_concepts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_match_concepts</span><span class="p">(</span><span class="n">tids</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">t_concepts</span><span class="p">,</span> <span class="n">related_relations</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">relations</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, KnowComp.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>